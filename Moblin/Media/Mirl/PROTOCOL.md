# Mirl protocol specification

## Goals
- Bonding.
- Prioritize audio over video.
- Adaptive bitrate friendly.
- Efficient. Low CPU usage.
- Simple.
- Fixed latency for video and audio?
- Dynamic latency for data? Deliver data when available (in order).

## URL

Format:

```
mirl://<address>:<port>/<stream-id>
```

Examples:

```
mirl://foobar.org:5566/ce4e0960-af23-40d4-85aa-d5b3245a6c92
mirl://kalle.com/1ecee59b-4200-4577-b1f0-b3bdaf6cb81b
mirl://184.65.22.133/ac10433a-ae84-4df6-bcb8-218a9488d065
mirl://192.168.0.53:5888/a6255ed8-fd3f-45bd-8e66-d144d7267e12
```

## Protocol

### Segment types

```
Name          Value  Direction         Has SN
-----------------------------------------------------------------------
video         0      client to server  yes
audio         1      client to server  yes
video empty   2      client to server  yes (same SN as original video)
audio empty   3      client to server  yes (same SN as original audio)
video format  4      client to server  yes
audio format  5      client to server  yes
mux           6      client to server  no  (contained segments have SN)
ack           7      both ways         no
data          8      both ways         yes
create group  9      both ways         no  (client initiated)
add to group  10     both ways         no  (client initiated)
```

### Flags
- First. First when set, consecutive otherwise.
- Id. Id is 0 when this flag is not set. This bit is not yet part of the segments below.

### Video codecs

```
Name          Value
---------------------
H.264         0
H.265         1
```

### Audio codecs

```
Name          Value
---------------------
AAC           0
```

### Comments
- Use transport layer packet length as segment length. Typically up to 1400 bytes (roughly MTU).
- `data` will need congestion control somehow. Probably as simple as a maximum number of outstanding
  packets.

### Segments

All segments starts with a 5 bits type.

First `video` or `audio` segment, first=1, including total length

```
+---------+-------------+--------------+--------+------------------+-------------------------+
| 5b type | 2b reserved | 1b first (1) | 24b SN | 24b total length | payload (PTS, DTS, ...) |
+---------+-------------+--------------+--------+------------------+-------------------------+
```

Continuation `video` or `audio` segment, first=0

```
+---------+-------------+--------------+--------+---------+
| 5b type | 2b reserved | 1b first (0) | 24b SN | payload |
+---------+-------------+--------------+--------+---------+
```

First `video format` or `audio format` segment, first=1, including total length

```
+---------+-------------+--------------+--------+----------+------------------+---------+
| 5b type | 2b reserved | 1b first (1) | 24b SN | 8b codec | 24b total length | payload |
+---------+-------------+--------------+--------+----------+------------------+---------+
```

Continuation `video format` or `audio format` segment, first=0

```
+---------+-------------+--------------+--------+---------+
| 5b type | 2b reserved | 1b first (0) | 24b SN | payload |
+---------+-------------+--------------+--------+---------+
```

`video empty` or `audio empty` segment, sent to drop given segment in receiver

```
+---------+-------------+--------+--------+
| 5b type | 3b reserved | 24b SN | 4b PTS |
+---------+-------------+--------+--------+
```

`mux` segment, containing at least two other segments

```
+---------+-------------+------------+-----------+------------+-----------+
| 5b type | 3b reserved | 16b length | segment 1 | 16b length | segment 2 |
+---------+-------------+------------+-----------+------------+-----------+
```

`ack` segment, sent every 50 ms on all connections

```
+---------+-------------+----------------+--------+--------+--------+--------+--------+
| 5b type | 3b reserved | 8b singles (3) | 24b SN | 24b SN | 24b SN | 24b SN | 24b SN |
+---------+-------------+----------------+--------+--------+--------+--------+--------+
                                           single   single   single        range
```

First `data` segment, first=1, including total length

```
+---------+-------------+--------------+--------+------------------+---------+
| 5b type | 2b reserved | 1b first (1) | 24b SN | 24b total length | payload |
+---------+-------------+--------------+--------+------------------+---------+
```

Continuation `data` segment, first=0

```
+---------+-------------+--------------+--------+---------+
| 5b type | 2b reserved | 1b first (0) | 24b SN | payload |
+---------+-------------+--------------+--------+---------+
```

`create group`, sent on first connection, response on same connection. UUID 1 generated by
client, UUID 2 generated by server.

```
+---------+-------------+-------------+-------------+
| 5b type | 3b reserved | 288b UUID 1 | 288b UUID 2 |
+---------+-------------+-------------+-------------+
```

`add to group`, sent on additional connections, response on same connection. UUID:s as
in `create group` from server.

```
+---------+-------------+-------------+-------------+
| 5b type | 3b reserved | 288b UUID 1 | 288b UUID 2 |
+---------+-------------+-------------+-------------+
```

## Sequence diagrams

### Typical streaming with two connections

```
+--------+        +--------------+   +--------------+   +--------+
| client |        | connection 1 |   | connection 2 |   | server |
+--------+        +--------------+   +--------------+   +--------+
    |                    |                  |               |
    |--- create group -->|--------------------------------->|
    |<-- create group ---|----------------------------------|
    |                    |                  |               |
    |--- add to group --------------------->|-------------->|
    |<-- add to group ----------------------|<--------------|
    |                    |                  |               |
    |--- video format -->|--------------------------------->|
    |--- audio format --------------------->|-------------->|
    |                    |                  |               |
    |------ video ------>|--------------------------------->|
    |------ video ------>|--------------------------------->|
    |------ audio ------>|--------------------------------->|
    |------ audio ------------------------->|-------------->|
    |                    |                  |               |
    |<------ ack --------|<---------------------------------|
    |<------ ack ---------------------------|<--------------|
    |                    |                  |               |
    .                    .                  .               .
    .                    .                  .               .
    .                    .                  .               .
```
